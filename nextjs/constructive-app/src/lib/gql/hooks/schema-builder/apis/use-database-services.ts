/**
 * Hook for fetching services (APIs with domains) within a specific database
 * @migrated Uses generated SDK execute adapter
 *
 * Note: This hook uses a custom query with nested relations (domains, apiSchemas)
 * which isn't directly generated by the SDK. We use the execute function directly.
 */

import { useQuery } from '@tanstack/react-query';

import { executeSb } from '@/graphql/execute';

export interface DatabaseService {
	id: string;
	name: string;
	roleName: string | null;
	anonRole: string | null;
	isPublic: boolean | null;
	dbname: string | null;
	databaseId: string;
	domains?: {
		nodes: Array<{
			domain: string | null;
			subdomain: string | null;
		}>;
	};
	apiSchemas?: {
		totalCount: number;
		nodes: Array<{
			id: string;
			schemaId: string;
			schema: {
				id: string;
				name: string;
			} | null;
		}>;
	};
}

interface DatabaseServicesQueryResult {
	apis: {
		nodes: DatabaseService[];
		totalCount: number;
	};
}

// Custom query with nested relations
const DATABASE_SERVICES_QUERY = `
	query DatabaseServices($databaseId: UUID!) {
		apis(condition: { databaseId: $databaseId }, orderBy: NAME_ASC) {
			nodes {
				id
				name
				roleName
				anonRole
				isPublic
				dbname
				databaseId
				domains {
					nodes {
						domain
						subdomain
					}
				}
				apiSchemas {
					totalCount
					nodes {
						id
						schemaId
						schema {
							id
							name
						}
					}
				}
			}
			totalCount
		}
	}
`;

export interface UseDatabaseServicesOptions {
	/** Database ID to fetch services for */
	databaseId: string;
	/** Enable/disable the query */
	enabled?: boolean;
}

export interface UseDatabaseServicesResult {
	/** Array of service objects */
	services: DatabaseService[];
	/** Total count of all services */
	totalCount: number;
	/** Loading state */
	isLoading: boolean;
	/** Error state */
	error: Error | null;
	/** Refetch function */
	refetch: () => Promise<unknown>;
}

/**
 * Hook for fetching services (APIs with domains) within a specific database
 */
export function useDatabaseServices(options: UseDatabaseServicesOptions): UseDatabaseServicesResult {
	const { databaseId, enabled = true } = options;
	const isEnabled = enabled && Boolean(databaseId);

	const { data, isLoading, error, refetch } = useQuery<DatabaseServicesQueryResult, Error>({
		queryKey: ['database-services', { databaseId }],
		queryFn: async () => {
			const result = (await executeSb(DATABASE_SERVICES_QUERY, {
				databaseId,
			})) as DatabaseServicesQueryResult;
			return result;
		},
		enabled: isEnabled,
		staleTime: 5 * 60 * 1000,
		refetchOnMount: isEnabled ? 'always' : false,
		refetchOnWindowFocus: 'always',
		refetchOnReconnect: 'always',
	});

	const services = data?.apis?.nodes ?? [];
	const totalCount = data?.apis?.totalCount ?? 0;

	return {
		services,
		totalCount,
		isLoading,
		error,
		refetch,
	};
}

/**
 * Generate query keys for consistent cache management
 */
export const databaseServicesQueryKeys = {
	all: ['database-services'] as const,
	byDatabase: (databaseId: string) => [...databaseServicesQueryKeys.all, { databaseId }] as const,
	byDatabaseWithOptions: (databaseId: string, options: Omit<UseDatabaseServicesOptions, 'databaseId'>) =>
		[...databaseServicesQueryKeys.byDatabase(databaseId), options] as const,
};
